{
  "engine":"nownodes",
  "name":"NowNodes HTTP(S) engine",
  "documentation" : "https://documenter.getpostman.com/view/13630829/TVmFkLwy",
  "APIkey": "yourApiKey",
  "cache":1000,
  "import": "transaction-history",
  "apiProvidesFullTx": false,
  "throttle":0.2,
  "timeout":24000,
  "longTimeout":60000,
  "shortTimeout":15000,
  "factor":8,
  "fee":0,
  "feePerByte":0,
  "confirmsRequired":6,
  "utxo_unspent_prefix":"76a914",
  "utxo_unspent_suffix":"88ac",
  "trimAddrHexL":"2",
  "trimAddrHexR":"8",
  "cron":600,
  "quartz":{
    "balance/address" : [
      "with address [regx,'^$prefix',1,2] [take,12]",
      "time $timeout",
      "curl {api-key:$APIkey} /api/v2/address/$address 2 1",
      "fail 'Connection to host failed'",
      "tran .balance 2 1",
      "fail 'Result from host invalid'",
      "atom"
    ],
    "unspent/source/amount/target=/publicKey/message" : [
      "with source [regx,'^$prefix',1,2] [take,12]",
      "data $amount",
      "ship @amountSpecified @amountSpecified 1 1",
      "call unspentAll/$source",
      "done",
      "@amountSpecified",
      "with target [regx,'^$prefix',1,2] [take,12]",
      "poke inputval '$amount' '1000000000000'",
      "with inputval atom 1",
      "time $timeout",
      "curl {api-key:$APIkey} /api/v2/utxo/$source?confirmed=true 2 1",
      "fail 'Could not connect to host'",
      "tran []{script:.scriptPubKey,amount:=.value,txid:.txid,txn:.vout} 2 1",
      "fail 'Parsing failed for unspents'",
      "sort '.amount'",
      "scan 'cnt<($inputval+val.amount)' '+val.amount'",
      "poke 'selected'",
      "tran '[].amount' 2 1",
      "data []",
      "math '+'",
      "with inputval [flow,'100000000000000000000',1,2] [done,'$'] [done]",
      "math '-$inputval'",
      "ship 2 2 1",
      "data 0",
      "done {unspents:$selected,change:'$'}"
    ],
    "unspentAll/source" : [
      "data '1000000000000'",
      "poke inputval",
      "time $timeout",
      "curl {api-key:$APIkey} /api/v2/utxo/$source?confirmed=true 2 1",
      "fail 'Could not connect to host'",
      "tran []{script:.scriptPubKey,amount:=.value,txid:.txid,txn:.vout} 2 1",
      "fail 'Could not parse unspents'",
      "poke 'selected'",
      "tran '[].amount' 2 1",
      "data []",
      "math '+'",
      "with inputval [flow,'100000000000000000000',1,2] [done,'$'] [done]",
      "ship 2 2 1",
      "data 0",
      "done {unspents:$selected,change:'$'}"
    ],
    "push/transaction" : [
      "time $timeout",
      "curl {api-key:$APIkey} /api/v2/sendtx/$transaction @curlSuccess @curlFail",
      "@curlFail",
      "fail 'Could not connect to host: $.'",
      "@curlSuccess",
      "tran .result 2 1",
      "fail 'Bad transaction result. $'",
      "done"
    ],
    "transactionData/txId" : [
      "curl {api-key:$APIkey} /tx/$txId 2 1",
      "fail 'Could not connect to host'"
    ],
    "reformatTx" : [
      "tran .value 2 1",
      "fail 'Could not parse transaction'",
      "with vout [data,${.vout}] [filt,.isAddress,true]",
      "with spends [peek,vout] [tran,[][.addresses, =atom(.value)]] [type,object]",
      "with .vout [peek,vout] [tran,[].addresses] [flat] [uniq] [join,',']",
      "with .vin [filt,.isAddress,true] [tran,[].addresses] [flat] [uniq] [join,',']",
      "tran {id:.txid, amount:.value, fee:.fees, source: .vin, symbol:'$symbol', 'fee-symbol':'$symbol', target: .vout, timestamp:.blockTime, confirmed:.confirmations, spends: $spends, height: .blockHeight} 2 1",
      "fail 'Failed to transform transaction data'",
      "with .fee atom false $factor",
      "with .amount atom false $factor"
    ],
    "getTransaction/txId" : [
      "time $timeout",
      "call transactionData/$txId",
      "data {value:$}",
      "call reformatTx",
      "done"
    ],
    "parseOpReturn/content":[
      "tran .value",
      "regx '^OP_RETURN \\(.*\\)$$' 2 1",
      "done ''",
      "drop 11 1"
    ],
    "message/txId" : [
      "call transactionData/$txId",
      "peek .vout",
      "filt .isAddress false",
      "tran [].addresses",
      "flat",
      "each parseOpReturn",
      "join"
    ],
    "getHistory/address/count=12/offset=0" : [
      "with address [regx,'^$prefix',1,2] [take,12]",
      "#Some logic to efficiently convert count,offset to page,pageSize",
      "true '$offset%$count==0' @straightforward @complex",
      "@straightforward",
      "poke pageSize $count",
      "poke drop 0",
      "with page math '$offset/$count'",
      "jump @curl",
      "@complex",
      "true '$offset<$count*2' 1 @largeOffset",
      "with pageSize math '$count+$offset'",
      "poke page 0",
      "poke drop $offset",
      "jump @curl",
      "@largeOffset",
      "with pageSize math '$count * 2'",
      "with page math 'floor($offset/($count*2))'",
      "with drop math '$offset%($count*2)'",
      "@curl",
      "with start math '$page*$pageSize'",
      "with end math '($page+1)*${pageSize}-1'",
      "curl {api-key:$APIkey} /api/v2//address/$address?page=$page&pageSize=$pageSize&details=txids 2 1",
      "fail 'Could not connect to host'",
      "tran .txids",
      "drop $drop",
      "head $count"
    ],
    "fee/message" : [
      "poke opreturnFee 0",
      "data $message",
      "void @finalize 1",
      "data '$message'",
      "ship 2 2 2 1",
      "size",
      "math '$*$feePerByte'",
      "poke opreturnFee",
      "@finalize",
      "peek local::fee $fee",
      "math '$+$opreturnFee'",
      "flow 'null' 1 2",
      "data '$fee'",
      "@feeDone"
    ],
    "sample" : [
      "done {address:'1F1tAaz5x1HUXrCNLbtMDqcw6o5GNn4xqX',transaction:'2c0832c153cf33327dae0e95a3bc39f4b02ae887725a32c07b1be47a2faffc55'}"
    ],
    "cron" : [
      "data '$symbol'",
      "flow 'undefined' 2 1",
      "call 'getFee'",
      "done"
    ],
    "getFee" : [
      "time $timeout",
      "with rId rand 10000",
      "data {API_key:'$APIkey',id:'$rId',method:'estimatesmartfee','params':[99]}",
      "curl / {Content-Type: 'application/json'} POST 2 1",
      "fail 'Could not connect to host'",
      "tran '.result.feerate' 2 1",
      "done",
      "# Raising the fee: we want our transaction to be mined within 30 minutes!",
      "math '*5'",
      "poke local::fee",
      "math '/100'",
      "poke local::feePerByte",
      "done"
    ]
  }
}
